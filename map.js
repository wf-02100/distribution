<div class="card operator-details">
    <div class="operator-details-headline">Klicken für mehr Details</div>
    <div id="opinfo_headline" style="font-size:2.5rem; font-weight:bold;font-family:Roboto Condensed,sans-serif;"> Betreiber wählen:</div>
    <div id="accordion">
      <div class="card border-0 rounded-0 mb-2">
        <a class="btn btn-link collapsed gm-operator-tab-navitem border-0 p-0" data-toggle="collapse" data-target="#collapse_michael_bethke" aria-expanded="true" onclick="tabclickop('michael_bethke')" aria-controls="collapse_michael_bethke" style="text-decoration:none">
          <div class="card-header rounded-0 panel-heading panelhead_michael_bethke border-0" id="headingOne">
            Michael Bethke
          </div>
        </a>

        <div id="collapse_michael_bethke" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
          <div class="card-body pt-0 pl-0 pr-0" style="background-color:#eee">
            <div class="row oval d-flex justify-content-center p-3" >
              <img alt="" class="operator-logo rounded mx-auto d-block" src="https://cdn.deutschland.immobilien/di/website/img/michaelbethke_logo.png" 
              style="object-fit: contain">
            </div>
            <div class="row d-flex justify-content-center">
              <div class="operator-adress">
                Michael Bethke<br>
                Am Borsigturm 12<br>
                13507 Berlin<br>
                <a href="https://www.michaelbethke.com" style="color: #d1232a;" target="_blank">www.michaelbethke.com</a>
              </div>
            </div>
            <div class="row gm-location-adresses p-3" id="gm-location-michael_bethke"></div>
          </div>
        </div>
      </div>

      <div class="card border-0 rounded-0 mb-2">
        <a class="btn btn-link collapsed gm-operator-tab-navitem border-0 p-0" data-toggle="collapse" data-target="#collapse_sonnenhalde" aria-expanded="false" onclick="tabclickop('sonnenhalde')" aria-controls="collapse_sonnenhalde" style="text-decoration:none">
          <div class="card-header rounded-0 panel-heading panelhead_sonnenhalde border-0" id="headingThree">
            Sonnenhalde
          </div>
        </a>
        <div id="collapse_sonnenhalde" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
          <div class="card-body pt-0 pl-0 pr-0" style="background-color:#eee">
            <div class="row oval d-flex justify-content-center p-3" style="overflow:hidden;">
              <img alt="" class="operator-logo rounded mx-auto d-block" src="https://cdn.deutschland.immobilien/di/website/img/servicehaussonnenhalde_logo.png">
            </div>
            <div class="row d-flex justify-content-center">
              <div class="operator-adress">
                Servicehaus Sonnenhalde<br>
                Keltenstr. 10<br>
                72829 Engstingen<br>
                <a href="https://www.servicehaus-sonnenhalde.de/" style="color: #d1232a;" target="_blank">servicehaus-sonnenhalde.de</a>
              </div>
            </div>
            <div class="row gm-location-adresses p-3" id="gm-location-sonnenhalde"></div>
          </div>
        </div>
      </div>

      <div class="card border-0 rounded-0 mb-2">
        <a class="btn btn-link collapsed gm-operator-tab-navitem border-0 p-0" data-toggle="collapse" data-target="#collapse_service_reif" aria-expanded="true" onclick="tabclickop('service_reif')" aria-controls="collapse_service_reif" style="text-decoration:none">
          <div class="card-header rounded-0 panel-heading panelhead_service_reif border-0" id="headingFour">
            Service Reif
          </div>
        </a>

        <div id="collapse_service_reif" class="collapse" aria-labelledby="headingFour" data-parent="#accordion">
          <div class="card-body pt-0 pl-0 pr-0" style="background-color:#eee">
            <div class="row oval d-flex justify-content-center p-3" style="overflow:hidden;">
              <img alt="" class="operator-logo rounded mx-auto d-block" src="https://cdn.deutschland.immobilien/di/website/img/seniorenservicereif_logo.png">
            </div>
            <div class="row d-flex justify-content-center">
              <div class="operator-adress">
                SeniorenService-Reif GmbH<br>
                Paul-Egleder-Weg 10<br>
                83052 Bruckmühl<br>
                <a href="https://www.pflegeheim-bruckmuehl.de/" style="color: #d1232a;" target="_blank">pflegeheim-bruckmuehl.de</a>
              </div>
            </div>
            <div class="row gm-location-adresses p-3" id="gm-location-service_reif"></div>
          </div>
        </div>
      </div>

      <div class="card border-0 rounded-0 mb-2">
        <a class="btn btn-link collapsed gm-operator-tab-navitem border-0 p-0" data-toggle="collapse" data-target="#collapse_sewo" aria-expanded="true" onclick="tabclickop('sewo')" aria-controls="collapse_sewo" style="text-decoration:none">
          <div class="card-header rounded-0 panel-heading panelhead_sewo border-0" id="headingFive">
            SeWo Seniorenbetreuungsgesellschaft
          </div>
        </a>

        <div id="collapse_sewo" class="collapse" aria-labelledby="headingFive" data-parent="#accordion">
          <div class="card-body pt-0 pl-0 pr-0" style="background-color:#eee">
            <div class="row oval d-flex justify-content-center p-3" style="overflow:hidden;">
              <img alt="" class="operator-logo rounded mx-auto d-block" src="https://cdn.deutschland.immobilien/di/website/bbp/Logo-SeWo.png">
            </div>
            <div class="row d-flex justify-content-center">
              <div class="operator-adress">
                SeWo Seniorenbetreuungsgesellschaft mbH<br>
                Sirgensteinstr. 2<br>
                88267 Vogt<br>
                <a href="https://www.pwh-schechingen.de/" style="color: #d1232a;" target="_blank">pwh-schechingen.de</a>
              </div>
            </div>
            <div class="row gm-location-adresses p-3" id="gm-location-sewo"></div>
          </div>
        </div>
      </div>
      
      <div class="card border-0 rounded-0 mb-2">
        <a class="btn btn-link collapsed gm-operator-tab-navitem border-0 p-0" data-toggle="collapse" data-target="#collapse_stegwiesen" aria-expanded="true" onclick="tabclickop('stegwiesen')" aria-controls="collapse_stegwiesen" style="text-decoration:none">
          <div class="card-header rounded-0 panel-heading panelhead_stegwiesen border-0" id="headingSix">
            Stegwiesen Pflegezentrum GmbH
          </div>
        </a>

        <div id="collapse_stegwiesen" class="collapse" aria-labelledby="headingSix" data-parent="#accordion">
          <div class="card-body pt-0 pl-0 pr-0" style="background-color:#eee">
            <div class="row oval d-flex justify-content-center p-3" style="overflow:hidden;">
              <img alt="" class="operator-logo rounded mx-auto d-block" src="https://cdn.deutschland.immobilien/di/website/bbp/Logo-Stegwiesen-Pflegezentrum.png">
            </div>
            <div class="row d-flex justify-content-center">
              <div class="operator-adress">
                Stegwiesen Pflegezentrum GmbH<br>
                Stegwiesen 13<br>
                78333 Stockach<br>
                <a href="https://www.stegwiesen-pflegezentrum.care/" style="color: #d1232a;" target="_blank">stegwiesen-pflegezentrum.care</a>
              </div>
            </div>
            <div class="row gm-location-adresses p-3" id="gm-location-stegwiesen"></div>
          </div>
        </div>
      </div>
      
    </div>
    <div class="d-flex justify-content-center">
      <a href="https://cdn.deutschland.immobilien/distaticfiles/dicms/projects/bevorzugtesbelegungsrechtNEU/Standorte%20Bev.%20Belegungsrecht%20PLUS.pdf"> </a>
    </div>
  </div>
        <div class="gm_container" id="gm_container">
        <!-- need to be implemented -->
<link href="https://use.fontawesome.com/releases/v5.5.0/css/fontawesome.css" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.5.0/css/solid.css" rel="stylesheet">
<script src="https://d3js.org/d3.v5.js"></script>


<!-- set the size of the map via the germanymap witdh/height -->
<div id="germanymap" class="germanymap d-flex justify-content-center">
  <div id="gm_modalPopUp" class="modal modal-rel">
    <div id="gm-modalPopUp-content">
    </div>
  </div>
  <div id="gm_svg_container">
      </div>
</div>

<script> var gm_locationData =[
  {
    "location": "Seniorenresidenz Haus Louise-Henriette von Oranien",
    "address": "Bernauer Str. 67, 16515 Oranienburg",
    "lat": "52.757230",
    "long": "13.249420",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenresidenz Haus Christo",
    "address": "Märkische Promenade 1A, 15827 Blankenfelde-Mahlow",
    "lat": "52.333600",
    "long": "13.404580",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenresidenz Haus Reicker Blick",
    "address": "Otto-Dix-Ring 61, 01219 Dresden",
    "lat": "51.018650",
    "long": "13.779950",
    "name": "michael_bethke"
  },
  {
    "location": "Tagespflege Haus Reicker Blick",
    "address": "Otto-Dix-Ring 61, 01219 Dresden",
    "lat": "51.018650",
    "long": "13.779950",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenwohnpark Liebenwalde",
    "address": "Berliner Straße 2,4,6,12, 6559 Liebenwalde",
    "lat": "52.8702108",
    "long": "13.3948931",
    "name": "michael_bethke"
  },
  {
    "location": "Tagespflege Immenhof",
    "address": "Schönfließer Straße 25h, 16540 Hohen Neuendorf",
    "lat": "52.6704484",
    "long": "13.2830853",
    "name": "michael_bethke"
  },
  {
    "location": "Senioren-Wohngemeinschaft Immenhof",
    "address": "Schönfließer Straße 25G-H, 16540 Hohen Neuendorf",
    "lat": "52.66879653930664",
    "long": "13.289952278137207",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenwohnen Haus Immenhof",
    "address": "Schönfließer Straße 25G-H, 16540 Hohen Neuendorf",
    "lat": "52.66879653930664",
    "long": "13.289952278137207",
    "name": "michael_bethke"
  },
  {
    "location": "Tagespflege Marielle",
    "address": "Seeburger Straße 8, 13581 Berlin",
    "lat": "52.5287087",
    "long": "13.1921555",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenwohnen Haus Christian",
    "address": "Ollenhauerstraße 24-24a, 13403 Berlin",
    "lat": "52.56829",
    "long": "13.329859",
    "name": "michael_bethke"
  },
  {
    "location": "Senioren-Wohngemeinschaft Villa Elfriede",
    "address": "Wandlitzstr. 15, 10318 Berlin",
    "lat": "52.4812887",
    "long": "13.5221962",
    "name": "michael_bethke"
  },
  {
    "location": "Senioren-Wohngemeinschaft Am Pichelssee und Burgwall",
    "address": "Seeburger Str. 9-11, 13581 Berlin",
    "lat": "52.5253987",
    "long": "13.1777781",
    "name": "michael_bethke"
  },
  {
    "location": "Seniorenresidenz und Betreutes Wohnen Am Hofwall",
    "address": "Am Hofwall, 01471 Radeburg",
    "lat": "51.215880",
    "long": "13.727560",
    "name": "michael_bethke"
  },

  {
    "location": "Pflegeimmobilie Bruckmühl",
    "address": "Paul-Egleder-Weg 10, 83052 Bruckmühl",
    "lat": "47.8788911",
    "long": "11.9083853",
    "name": "service_reif"
  },
  {
    "location": "Pflegeheim Blumberg",
    "address": "Achdorfer Straße 33, 78176 Blumberg",
    "lat": "47.842060",
    "long": "8.533330",
    "name": "sonnenhalde"
  },
  {

    "location": "Pflegeheim Engstingen",
    "address": "Sonnenhalde 65, 72829 Engstingen",
    "lat": "48.3789429",
    "long": "9.2861735",
    "name": "sonnenhalde"
  },
  {

    "location": "Pflegeheim Stockach GmbH",
    "address": "Winterspürerstraße 19, 78333 Stockach",
    "lat": "47.8522151",
    "long": "9.0190018",
    "name": "sonnenhalde"
  },
  {
    "location": "Pflegeheim Singen",
    "address": "Schaffhauser Str.9, 78224 Singen",
    "lat": "47.762334",
    "long": "8.8319996",
    "name": "sonnenhalde"
  },
  {
    "location": "Pflegeheim Tengen",
    "address": "Dr.-Augele-Str. 2, 78250 Tengen",
    "lat": "48.714790",
    "long": "9.824490",
    "name": "sonnenhalde"
  },
  {
    "location": "Pflegeheim Trochtelfingen",
    "address": "Grafentalweg 15, 72818 Trochtelfingen",
    "lat": "48.30951",
    "long": "9.23159",
    "name": "sonnenhalde"
  },
  {
    "location": "Pflegeheim Westerheim",
    "address": "Daußhalde 2, 72589 Westerheim",
    "lat": "48.5144065",
    "long": "9.6180458",
    "name": "sonnenhalde"
  },
  {
    "location": "Seniorenresidenz Göggingen",
    "address": "Zum Steingau 8, 73571 Göggingen",
    "lat": "48.8583613",
    "long": "9.8750843",
    "name": "sewo"
  }
]
; var gm_zoomable = false;  var gm_modalable = false; var gm_offset_left = -2.8;var gm_offset_top = 0;GermanyMap = (function() {

  var $gm_modal;
  var gm_modal;

  var init = function(gm_locationData, gm_zoomable, gm_modalable) {
    var germanymap = document.getElementById('germanymap');
    var gm_parent = germanymap.parentElement;
    var gm_width = gm_parent.offsetWidth;
    var gm_height = gm_parent.offsetHeight;
    var gm_height = (gm_height != 0 ? gm_height : 450);
    var gm_width = (gm_width != 0 ? gm_width : 300);
    // var gm_width = $(window).width();
    var rotate = [6, 0];
    var gm_center = [(gm_width) / 2, gm_height / 2];
    var gm_svg_container = document.getElementById('gm_svg_container');
    var centered;
    // gm_svg_container.style.height = gm_height + "px";


    if ((typeof gm_offset_left !== 'undefined') && (typeof gm_offset_top !== 'undefined')) {
      var gm_offset = [(16.5 + gm_offset_left), (51.3 + gm_offset_top)];
      var gm_center = [(gm_width - (gm_offset_left * 100)) / 2, (gm_height + (gm_offset_top * 100)) / 2];
    } else {
      var gm_offset = [16.5, 51.3];
      var gm_center = [(gm_width) / 2, gm_height / 2];
    }

    if (gm_modalable) {
      $gm_modal = $("#gm_modalPopUp");
      gm_modal = document.getElementById("gm_modalPopUp");
    }


    if (gm_locationData) {
      gm_locationData.forEach((location, i) => {
        var id = {
          'id': i
        };
        location.id = i;
      });
    } else {
      var gm_locationData = 0;
    }


    var gm_zoom = d3.zoom()
      .scaleExtent([1, 40]) //vergrößerung
      .translateExtent([
        [0, 0],
        [gm_width, gm_height]
      ])
      // .center([4.5, 51.3])
      .on("zoom", zoomed);

    var svg = d3.select("div#gm_svg_container")
      .append("svg")
      // .attr("preserveAspectRatio", "xMinYMin meet")
      // .attr("viewBox", "0 0 900 900")
      .classed("gm_svg_content", true)
      .classed("svg-content-responsive", true)
      .attr("width", gm_width)
      .attr("height", gm_height)
      .attr("overflow", "visible")
      .call(responsivefy);

    var g = svg.append("g");


    if (gm_zoomable == true) {
      svg.call(gm_zoom)
        .on(gm_zoom.touchable, true);
    } else if (gm_zoomable == "btn") {
      svg.call(gm_zoom)
        .on(gm_zoom.touchable, false)
        .on("wheel.zoom", null);
    }

    var scale_x = (gm_width * 6);
    var scale_y = (gm_height * 4);

    if (scale_x != scale_y) {
      var scale = ((scale_x > scale_y) ? scale_y : scale_x);
    } else {
      var scale = scale_x;
    }
    var circleradius = (scale / 500);

    if ($(window).width() <= 1000) {
      var rotate = [6 + gm_offset_left, gm_offset_top]; //Rotation of the earth
      var gm_center = [(gm_width) / 2, gm_height / 2];

    }

    var projection = d3.geoMercator()
      .translate([gm_width / 2, gm_height / 2])
      .scale(scale)
      // .center([10.5, 51.3])
      .center(gm_offset)
      .rotate(rotate);  //Rotation of the earth

    var path = d3.geoPath()
      .projection(projection);

    // load data
    var germany = d3.json("/assets_static/global/germanymap/germany.json");


    // ====== Zoombuttons =======
    // Zoom out
    d3.select(".gm_zoomOut")
      .on("click", function() {
        gm_zoom.scaleBy(svg.transition().duration(150), 1 / 1.3, gm_center);
      });

    // Zoom in
    d3.select(".gm_zoomIn")
      .on("click", function() {
        gm_zoom.scaleBy(svg.transition().duration(150), 1.3, gm_center);
      });

    // Zoom Reset
    d3.select(".gm_zoomReset")
      .on("click", function() {
        g.selectAll("path").classed("active", false);
        svg.classed("clicked_path", false);

        svg.transition().duration(750).call(
          gm_zoom.transform,
          d3.zoomIdentity
          .translate(gm_width / 2, gm_height / 2)
          .scale(1)
          .translate(-(gm_width / 2), -(gm_height / 2)),
          d3.mouse(svg.node())
        );
      });

    Promise.all([germany, gm_locationData]).then(function(values) {

      // Create Tooltips
      var tooltip = d3.select("div#gm_svg_container")
        .append("div")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .data(values[1]);


      // draw map
      g.selectAll("path")
        .data(values[0].features)
        .enter()
        .append("path")
        .attr("class", "states geopath")
        .attr("d", path)
        .attr("id", function(d) {
          return 'path_' + d.properties.NAME_1 + '_' + d.id;
        })
        .on("click", gm_stateclick);
      // .on("click", function(d) {
      //   if (gm_zoomable == 'btn') {
      //     gm_statezoom(d);
      //   } else if (gm_states_action == 'click') {
      //     gm_stateclick(d);
      //   }
      // });


      // draw points
      g.selectAll("circle")
        .data(values[1])
        .enter()
        .append("circle")
        .attr("class", function(d) {
          return "circles circle_" + d.name;
        })
        .attr("id", function(d) {
          return ("circle_" + d.id);
        })
        .attr("cx", function(d) {
          return projection([d.long, d.lat])[0];
        })
        .attr("cy", function(d) {
          return projection([d.long, d.lat])[1];
        })
        .attr("r", circleradius)
        .attr("stroke-width", circleradius + "px")
        .attr("filter", "url(#drop-shadow)")
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave)
        .on("click", function(d) {
          if (gm_modalable) {
            mouseclick(d);
          } else {
            return;
          }
        });

      // ============= Mouse Over =============================d
      function mouseover(d) {

        //position/offset of element relative to the parent container
        var childPos = $("#circle_" + d.id).offset();
        var parentPos = $(".gm_svg_content").offset();
        var childOffset = {
          top: childPos.top - parentPos.top,
          left: childPos.left - parentPos.left
        }
        d.address = d.address.replace(',', '<br>');

        d.name = d.name.replace(/_/g, " ");
        d.name = capitalizeTheFirstLetterOfEachWord(d.name);

        // switch (d.name) {
        //   case 'convivo':
        //     d.name = 'Convivo';
        //     break;
        //   case 'michael_bethke':
        //     d.name = 'Michael Bethke';
        //     break;
        //   case 'sonnenhalde':
        //     d.name = 'Sonnenhalde';
        //     break;
        //   case 'service_reif':
        //     d.name = 'Service Reif';
        //     break;
        //   case 'kollmeier':
        //     d.name = 'Kollmeier';
        //     break;
        //   default:
        //
        // }
        // tooltip_content = '<div class="card shadow tooltip_card"><div class="tooltip_line tooltip_line_animated"></div><span class="tooltip_dot"></span><div class="card-body p-0 tooltip_card_body"><div class="tooltip_headline card-title m-0 d-flex justify-content-start">' + d.location + '</div><div class="nexttext d-flex justify-content-start"><p class="card-text tooltip_txt">'+d.address+'</p><p class="card-text tooltip_small_txt"><small class="text-muted">'+d.name+'</small></p></div></div>';

        tooltip_content = '<div class="tooltip_line tooltip_line_animated"></div><div class="card shadow  tooltip_card"><span class="dot_2"></span><div class="tooltip_card_body"><div class="row"><div class="col"><div class="tooltip_headline d-flex justify-content-start">' + d.location + '</div></div></div><div class="row"><div class="col"><div class="nexttext d-flex justify-content-start"><p class="card-text tooltip_small_txt">' + d.name + '</p></div></div></div><div class="row"><div class="col"><div>' + d.address + '</div></div></div></div></div>';

        if (gm_modalable) {
          tooltip_content += '<div class="row"><div class="undertxt m-0">Klicken um zu halten</div></div>';
        }

        // tooltip is shown
        tooltip
          .data(values[1])
          .html(tooltip_content)
          .style("left", (childOffset.left + 40) + "px") //müssen bei größen änderungen angepasst werden!!!
          // .style("left", (childOffset.left + 67) + "px")
          .style("top", (childOffset.top - 20) + "px")
          .attr("class", "active_tooltip tooltip");

        d3.selectAll('.tooltip_card')
          .transition()
          .duration(300)
          .style("opacity", 1);

        tooltip
          .transition()
          .duration(600)
          .style("opacity", 1)
          .style('pointer-events', 'none');

        var line = d3.select("div.tooltip_line")
          .append("svg")
          .attr("width", "2cm")
          .attr("height", "1.5cm")
          .attr("viewBox", "0 0 1200 600")
          .append("path")
          .attr("class", "line_path")
          .attr("d", "M 520 255 l 500 0")
          // .attr("d", "M100,200 Q400,50 600,200 T1000,200")
          .attr("fill", "none")
          .attr("stroke", "#b91923")
          .attr("stroke-width", "15")
      }

      // ============= Mouse Move =========================
      function mousemove(d) {

        tooltip
          .style("opacity", 1);

        d3.selectAll('.tooltip_card')
          .transition()
          .duration(300)
          .style("opacity", 1);
      }

      // ================ Mouse Leave ===================
      function mouseleave(d) {

        tooltip
          .style("opacity", 0)
          .html('')
          .classed("active_tooltip", false)

      }

      // ======================= Mouse Click ================
      function mouseclick(d) {

        tooltip
          .style("opacity", 0)
          .html('')

        // height width of modal
        $gm_modal.width(gm_width);
        $gm_modal.height(gm_height);



        var childOffset = $(".gm_svg_content").offset();

        var containerPos = {
          top: germanymap.parentNode.offsetTop,
          left: germanymap.parentNode.getBoundingClientRect().left
        };
        var modalOfsset = {
          top: childOffset.top - containerPos.top,
          left: childOffset.left - containerPos.left
        };


        // position of modal
        gm_modal.style.left = (modalOfsset.left) + "px";
        gm_modal.style.top = (modalOfsset.top) + "px";

        var gm_modal_content = document.getElementById("gm-modalPopUp-content");
        var gm_modal_htmlcontent = '<div class="card shadow tooltip_card"><div class="modal_line"></div><span class="modal_dot"></span><div class="modal-header p-0 border-0"><div class="tooltip_headline modal-title m-0 d-flex justify-content-start">' + d.location + '</div><button type="button" class="close close_btn pl-0 pr-1" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="card-body p-0 tooltip_card_body"><div class="nexttext d-flex justify-content-start"><p class="card-text tooltip_asset"><small class="text-muted">Rendite</small></p></div><p class="card-text m-0 tooltip_txt">Lorem ipsum...</p><p class="card-text tooltip_small_txt"><small class="text-muted">Last updated 3 mins ago</small></p></div></div>';

        gm_modal_content.innerHTML = gm_modal_htmlcontent;

        // if Window Width is smaller than 576px the modal is shown in the center of the map
        if ($(window).width() <= 576) {
          console.log("too small ;)");

          //Map gets gray
          svg.selectAll("path")
            .transition()
            .style("fill", "black")
            .style("fill-opacity", "0.5 ")

          svg.selectAll("circle")
            .transition()
            .style("fill", "black")
            .style("fill-opacity", "0.5 ")

          // position of Modal
          gm_modal_content.style.left = (($gm_modal.width() / 2) - 100) + "px";
          gm_modal_content.style.top = (($gm_modal.height() / 2) - 75) + "px";
        } else {

          //position/offset of element relative to the parent container
          var childPos = $("#circle_" + d.id).offset();

          var modalOfsset = {
            top: childPos.top - childOffset.top,
            left: childPos.left - childOffset.left
          }


          gm_modal_content.style.left = (modalOfsset.left + 85) + "px";
          gm_modal_content.style.top = (modalOfsset.top - 25) + "px";

          // line
          d3.select("div.modal_line")
            .append("svg")
            .attr("width", "3cm")
            .attr("height", "1.5cm")
            .attr("viewBox", "0 0 1200 600")
            .append("path")
            .attr("class", "line_path")
            .attr("d", "M200,300 Q400,50 600,300 T1000,300")
            .attr("fill", "none")
            .attr("stroke", "#b91923")
            .attr("stroke-width", "15")
        }

        $gm_modal.modal();

        $('body').removeClass("modal-open")
        $('body').css("padding-right", "");

        $('.modal-backdrop').appendTo('.germanymap');

      }

      if (gm_modalable) {
        $gm_modal.on('hidden.bs.modal', function() {
          svg.selectAll("path")
            .transition()
            .style("fill", "white")
            .style("fill-opacity", "1")

          svg.selectAll("circle")
            .transition()
            .style("fill", "#b91923")
            .style("fill-opacity", "1")
        });
      }

      var defs = svg.append("defs");

      var dropShadowFilter = defs.append('svg:filter')
        .attr('id', 'drop-shadow2')
        .attr('filterUnits', "userSpaceOnUse")
        .attr('width', '100%')
        .attr('height', '100%');
      dropShadowFilter.append('svg:feGaussianBlur')
        .attr('in', 'SourceGraphic')
        .attr('stdDeviation', 1)
        .attr('result', 'blur-out');
      dropShadowFilter.append('svg:feOffset')
        .attr('in', 'color-out')
        // .attr('dx', 0)
        .attr('dy', 1)
        .attr('result', 'the-shadow');
      dropShadowFilter.append('svg:feBlend')
        .attr('in', 'SourceGraphic')
        .attr('in2', 'the-shadow')
        .attr('mode', 'normal');

      dropShadowFilter.append("svg:feComponentTransfer")
        .append("svg:feFuncA")
        .attr("type", "linear")
        .attr("slope", 0.8);

      var dropShadowFilter = defs.append('svg:filter')
        .attr('id', 'drop-shadow')
        .attr('filterUnits', "userSpaceOnUse")
        .attr('width', '100%')
        .attr('height', '100%');

      dropShadowFilter.append('svg:feGaussianBlur')
        .attr("in", "SourceAlpha")
        .attr("stdDeviation", 1);
      dropShadowFilter.append('svg:feOffset')
        // .attr("dx", 1)
        .attr("dy", 1);
      var femerg = dropShadowFilter.append('svg:feMerge');
      femerg.append("svg:feMergeNode");
      femerg.append("svg:feMergeNode")
        .attr("in", "SourceGraphic");


    });

    function gm_stateclick(d) {
      if (gm_zoomable == 'btn') {

        var lele = $("#" + d.properties.VARNAME_1);
        d3.event.stopPropagation();

        if (d && centered !== d) {
          const [
            [x0, y0],
            [x1, y1]
          ] = path.bounds(d);

          if ($(window).width() <= 1000) {
            x2 = gm_width / 2;
            y2 = gm_height / 2;

          } else {
            x2 = (gm_width - (gm_offset_left * 100)) / 2;
            y2 = (gm_height + (gm_offset_top * 100)) / 2;

          }

          x3 = (x0 + x1) / 2;
          y3 = (y0 + y1) / 2;
          k = Math.min(8, 0.9 / Math.max((x1 - x0) / gm_width, (y1 - y0) / gm_height));
          centered = d;
        } else {
          x2 = gm_width / 2;
          y2 = gm_height / 2;
          x3 = gm_width / 2;
          y3 = gm_height / 2;
          k = 1;
          centered = null;
        }
        d3.select(this).raise();
        d3.selectAll("circle").raise();

        g.selectAll("path")
          .classed("active", centered && function(d) {
            return d === centered;
          });

        svg.classed("clicked_path", centered);

        svg.transition().duration(750).call(
          gm_zoom.transform,
          d3.zoomIdentity
          .translate(x2, y2)
          .scale(k)
          .translate(-x3, -y3),
          d3.mouse(svg.node())
        );
      } else if (gm_states_action == 'click') {

        var states_list = document.getElementById("states_list");
        if (states_list) states_list.selectedIndex = d.id;

        g.selectAll("path")
          .classed("active", false);

        d3.select(this)
          .raise()
          .classed("active", true);

        document.getElementById("card_body_germanywide").classList.remove("active");
        document.getElementById("card_germanywide").classList.add("inactive");
        document.getElementById("card_body_states").classList.add("active");
        document.getElementById("card_states").classList.remove("inactive");

        var so_location = document.getElementById("so_location")
        if (so_location) so_location.innerHTML = d.properties.NAME_1;
        document.getElementById("LeadForm_interest_state").value = d.properties.NAME_1;

      }
    }

    // function gm_statezoom(d) {
    //
    //   var lele = $("#" + d.properties.VARNAME_1);
    //   d3.event.stopPropagation();
    //
    //   if (d && centered !== d) {
    //     const [
    //       [x0, y0],
    //       [x1, y1]
    //     ] = path.bounds(d);
    //
    //     if ($(window).width() <= 1000) {
    //       x2 = gm_width / 2;
    //     } else {
    //       x2 = (gm_width) / 2;
    //     }
    //
    //     y2 = gm_height / 2;
    //     x3 = (x0 + x1) / 2;
    //     y3 = (y0 + y1) / 2;
    //     k = Math.min(8, 0.9 / Math.max((x1 - x0) / gm_width, (y1 - y0) / gm_height));
    //     centered = d;
    //   } else {
    //     x2 = gm_width / 2;
    //     y2 = gm_height / 2;
    //     x3 = gm_width / 2;
    //     y3 = gm_height / 2;
    //     k = 1;
    //     centered = null;
    //   }
    //   d3.select(d).raise();
    //   d3.selectAll("circle").raise();
    //
    //   g.selectAll("path")
    //     .classed("active", centered && function(d) {
    //       return d === centered;
    //     });
    //
    //   svg.classed("clicked_path", centered);
    //
    //   svg.transition().duration(750).call(
    //     gm_zoom.transform,
    //     d3.zoomIdentity
    //     .translate(x2, y2)
    //     .scale(k)
    //     .translate(-x3, -y3),
    //     d3.mouse(svg.node())
    //   );
    // }

    function zoomed() {
      var e = d3.event.transform;
      // g.attr("transform", "translate("+e.x+","+e.y+")scale(1)");
      g.attr("transform", e);
      // projection.translate(""+e.y+","+e.x+"").scale(e.k);
      // g.selectAll("path").attr("d", path);

      g.selectAll('circle')
        .attr("r", circleradius / e.k)
        .attr("stroke-width", (circleradius / e.k))
        .attr("filter", "url(#drop-shadow)");


      if (e.k != 1) {
        $('.gm_zoomReset').css('visibility', 'visible');
      } else {
        $('.gm_zoomReset').css('visibility', 'hidden');

        g.selectAll("path").classed("active", false);
        svg.classed("clicked_path", false);
      }

    }

    function responsivefy(svg) {

      var container = d3.select(svg.node().parentNode),
        width = parseInt(svg.style("width")),
        height = parseInt(svg.style("height")),
        aspect = width / height;

      svg.attr("viewBox", "0 0 " + width + " " + height)
        .attr("perserveAspectRatio", "xMinYMid")
        .call(resize);

      d3.select(window).on("resize." + container.attr("id"), resize);

      function resize() {
        var targetWidth = parseInt(container.style("width"));
        var targetHeight = parseInt(container.style("height"));
        svg.attr("width", targetWidth);
        svg.attr("height", targetHeight);
      }
    }

    function capitalizeTheFirstLetterOfEachWord(words) {
      var separateWord = words.toLowerCase().split(' ');
      for (var i = 0; i < separateWord.length; i++) {
        separateWord[i] = separateWord[i].charAt(0).toUpperCase() +
          separateWord[i].substring(1);
      }
      return separateWord.join(' ');
    }

  }

  return {
    init: init
  }

})();


document.addEventListener("DOMContentLoaded", function(event) {
  GermanyMap.init(gm_locationData, gm_zoomable, gm_modalable);
});
</script>
